# Дизайн системы управления ценами (Price Management System)

## 1. Обзор архитектуры

Система спроектирована для обеспечения гибкости управления ценами через Excel-файлы, при этом сохраняя производительность и надежность фронтенда.

### Потоки данных

1.  **Редактирование (Admins/Business)**:
    *   Администратор скачивает шаблон Excel.
    *   Редактирует цены и параметры в Excel.
    *   Загружает файл через Админ-панель (или передает разработчику для MVP).

2.  **Обработка (Server/Script)**:
    *   Excel парсится.
    *   Валидируются ключи и типы данных.
    *   Генерируется оптимизированный `prices.json`.
    *   Файл сохраняется в публичную директорию (или БД).

3.  **Потребление (Frontend)**:
    *   `CanopyModel` запрашивает `/api/prices` (или `prices.json`).
    *   Данные кэшируются.
    *   Расчеты производятся на основе полученных ключей.

---

## 2. Формат Excel (Price Template)

Файл: `prices_v1.xlsx`
Лист: `Prices`

| key (Не менять!) | name (Описание) | unit (Ед. изм.) | price (Цена) | category (Категория) |
| :--- | :--- | :--- | :--- | :--- |
| `post_glued_150x150` | Столб клееный 150х150 | m | 1500 | wood |
| `roof_metal_grandline` | Металлочерепица GrandLine | m2 | 650 | roof |
| `mounting_base` | Монтаж (база) | m2 | 2500 | service |
| `delivery_mkad` | Доставка от МКАД | km | 35 | service |
| `markup_factor` | Коэффициент наценки | factor | 1.15 | global |

**Правила для заказчика:**
1.  Колонка `key` — **СВЯЩЕННА**. Её нельзя менять, удалять или переименовывать.
2.  Редактировать можно только колонки `price` (числа) и `name` (для удобства, на сайте не всегда используется).
3.  `unit` носит информативный характер для оператора, но валидируется на сервере.

---

## 3. Структура prices.json (API Response)

Файл должен быть максимально плоским и простым для чтения фронтендом.

```json
{
  "meta": {
    "version": "1.0.2",
    "updatedAt": "2026-01-11T12:00:00Z",
    "currency": "RUB"
  },
  "items": {
    "post_glued_150x150": 1500,
    "roof_metal_grandline": 650,
    "mounting_base": 2500,
    "delivery_mkad": 35,
    "markup_factor": 1.15
  }
}
```

*Примечание: Мы намеренно убираем `unit`, `category` и `name` из JSON, который идет на фронт (или выносим в отдельный мета-объект), чтобы минимизировать трафик, если фронтенду нужны только цифры для расчетов. Однако для UI админки может потребоваться полная версия.*

**Вариант "Full" (если нужно отображать прайс на сайте):**

```json
{
  "meta": { ... },
  "items": {
    "post_glued_150x150": { "p": 1500, "u": "m", "n": "Столб клееный 150х150" }
  }
}
```
*Рекомендуем простой вариант (Key-Value) для калькулятора, так как названия материалов часто зашиты в UI селекторах.*

---

## 4. API Контракт

### GET /api/prices
Возвращает актуальные цены.
**Response 200 OK**:
```json
{
  "version": "1.1",
  "data": {
    "post_glued_150x150": 1500,
    ...
  }
}
```

### POST /api/prices/upload
Загрузка Excel файла.
**Body**: `multipart/form-data`, field `file`.
**Response 200 OK**:
```json
{
  "success": true,
  "version": "1.2",
  "itemsUpdated": 45
}
```
**Response 400 Bad Request**:
- Если отсутствуют обязательные ключи.
- Если цены отрицательные.

---

## 5. Обновленная логика Frontend (CanopyModel)

1.  **Инициализация (boot)**:
    *   При создании `CanopyModel` запускаем `fetch('/upload/naves/prices.json?' + timestamp)`.
    *   Добавляем timestamp, чтобы избежать кэширования браузером.
2.  **Fallback**:
    *   Если fetch падает (сеть, 404, JSON parse error) -> используем `DEFAULT_PRICES` (хардкод в коде).
    *   Показываем пользователю уведомление (тихое в консоль или warning иконку), что "Цены могут быть неактуальны".
3.  **Расчет (calculateCost)**:
    *   Метод `getPrice(key)` ищет сначала в загруженном JSON.
    *   Если нет -> ищет в Default.
    *   Если нет -> возвращает 0 и логирует Error «Price for ${key} not found».

---

## 6. Рекомендации по реализации (Next Steps)

1.  Создать скрипт `scripts/excel-to-json.js` (Node.js) для конвертации `prices.xlsx` -> `prices.json`.
2.  Обновить `CanopyModel.js` для поддержки новой структуры JSON.
3.  В `getDefaultPrices` оставить только критически важные позиции для Fallback.
